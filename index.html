<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng Sắt Thép - SteelPro</title>
    <!-- Dependencies -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>


    <!-- Luckysheet Dependencies -->
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/luckysheet.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckyexcel@1.0.1/dist/luckyexcel.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #f97316;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: none;
        }

        /* CỐ ĐỊNH LỚP VẼ CANVAS ĐỂ KHÔNG BỊ ẨN */
        canvas.luckysheet-grid-window {
            z-index: 100 !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* CHỈ CHẶN ĐÚNG CÁC MÀN HÌNH CHỜ */
        .luckysheet-loading-mask,
        #luckysheet-loading-mask,
        .luckysheet-load {
            display: none !important;
            opacity: 0 !important;
            z-index: -9999 !important;
            pointer-events: none !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 50;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius);
            color: var(--text-muted);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white !important;
        }

        .main-content {
            margin-left: 260px;
            padding: 2rem 3rem;
            flex-grow: 1;
            width: calc(100% - 260px);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 10;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: var(--border);
        }

        .hidden {
            display: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
            margin-top: 8px;
        }

        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-table {
            width: 100%;
            border-collapse: collapse;
        }

        .app-table th {
            background: var(--bg-body);
            padding: 12px 1rem;
            text-align: left;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .app-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-delivered {
            background: #dcfce7;
            color: #166534;
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .excel-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.3s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Triệt hạ hoàn toàn các màn hình Loading của Luckysheet */
        div[class*="loading-mask"],
        .luckysheet-loading-mask,
        .luckysheet-mask {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* --- LOGIN VIEW --- */
        #view-login {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #111;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(45deg, #111 0%, #202020 100%);
        }

        .login-card {
            background: #2b2b2b;
            padding: 2.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
        }

        .login-input:focus {
            border-color: var(--primary);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: var(--primary-dark);
        }

        /* --- EXCEL RIBBON UI --- */

        #excel-app-container,
        #excel-ui-wrapper {
            background-color: #2b2b2b;
            /* Dark Excel Background */
        }

        /* 1. TITLE BAR */
        #excel-title-bar {
            height: 38px;
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            color: #ffffff;
            font-size: 13px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .excel-title-center {
            font-weight: 500;
            opacity: 0.9;
            font-family: "Segoe UI", sans-serif;
        }

        .excel-window-controls {
            display: flex;
            gap: 8px;
        }

        .excel-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #555;
            cursor: pointer;
        }

        .excel-control-btn.red {
            background: #ff5f57;
        }

        .excel-control-btn.yellow {
            background: #febc2e;
        }

        .excel-control-btn.green {
            background: #28c840;
        }

        /* 3. RIBBON PANEL (Toolbar) */
        #excel-ribbon-panel {
            min-height: 90px;
            background-color: #2b2b2b;
            border-bottom: 1px solid #3d3d3d;
            display: flex;
            padding: 4px 6px;
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
            user-select: none;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            padding: 0 6px;
            align-items: center;
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .group-content {
            display: flex;
            gap: 4px;
            flex: 1;
            /* Push label down */
            align-items: flex-start;
        }

        .group-label {
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
            margin-bottom: 2px;
            text-align: center;
        }

        /* Ribbon Buttons */
        .ribbon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ddd;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .ribbon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .ribbon-btn.large {
            padding: 4px 8px;
            height: 64px;
            min-width: 40px;
        }

        .ribbon-btn.large span {
            font-size: 11px;
            margin-top: 4px;
        }

        .ribbon-btn.small-row {
            flex-direction: row;
            padding: 2px 4px;
            gap: 4px;
        }

        .ribbon-col {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ribbon-row {
            display: flex;
            gap: 2px;
        }

        .ribbon-input {
            background: #202020;
            border: 1px solid #444;
            color: white;
            font-size: 12px;
            padding: 2px 4px;
            border-radius: 3px;
            outline: none;
        }

        /* Select box simulation */
        .ribbon-select {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #202020;
            border: 1px solid #444;
            color: white;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
            padding: 0 4px;
        }

        /* Hide Default Luckysheet Toolbar (Soft Hide) */
        /* We use visibility:hidden + absolute instead of display:none so elements remain "clickable" via JS */
        .luckysheet-grid-menu,
        div.luckysheet-grid-menu,
        .luckysheet-toolbar-container,
        div.luckysheet-toolbar-container {
            /* display: none !important; */
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            top: -10000px !important;
            z-index: -9999 !important;
            /* pointer-events: none !important; <-- REMOVED to allow JS click simulation */
        }

        /* FORCE DISPLAY INPUT BOX (Fix Blind Typing) */
        /* FORCE DISPLAY INPUT BOX (Fix Blind Typing) */
        .luckysheet-input-box {
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
            z-index: 100000 !important;
            /* REMOVED top/position overrides to let Luckysheet JS handle it */
            pointer-events: auto !important;
            background: white !important;
            /* Ensure high contrast */
            color: black !important;
        }

        /* 2. RIBBON TABS */
        #excel-ribbon-tabs {
            height: 48px;
            background-color: #2b2b2b;
            display: flex;
            align-items: flex-end;
            padding-left: 10px;
            border-bottom: 1px solid #3d3d3d;
            flex-shrink: 0;
        }

        .excel-tab {
            padding: 10px 18px;
            color: #dcdcdc;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: color 0.1s;
        }

        .excel-tab:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .excel-tab.active-tab {
            color: #107c41;
            font-weight: 600;
            background-color: transparent;
        }

        .excel-tab.active-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 3px;
            background-color: #107c41;
            border-radius: 3px 3px 0 0;
        }

        .excel-file-highlight {
            color: #ffffff !important;
            font-weight: 600;
            margin-right: 4px;
        }

        /* --- EXCEL RIBBON UI --- */
        #excel-app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background-color: #2b2b2b;
            /* Dark Excel Background */
            overflow: hidden;
        }

        /* 1. TITLE BAR */
        #excel-title-bar {
            height: 38px;
            /* Slightly taller for modern look */
            background-color: #1a1a1a;
            /* Darkest top strip */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            color: #ffffff;
            font-size: 13px;
            border-bottom: 1px solid #333;
        }

        .excel-title-center {
            font-weight: 500;
            opacity: 0.9;
        }

        .excel-window-controls {
            display: flex;
            gap: 12px;
        }

        .excel-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #555;
            cursor: pointer;
        }

        .excel-control-btn.red {
            background: #ff5f57;
        }

        .excel-control-btn.yellow {
            background: #febc2e;
        }

        .excel-control-btn.green {
            background: #28c840;
        }

        /* 2. RIBBON TABS */
        #excel-ribbon-tabs {
            height: 48px;
            /* Standard ribbon height */
            background-color: #2b2b2b;
            /* Slightly lighter than title bar */
            display: flex;
            align-items: flex-end;
            /* Tabs sit at bottom */
            padding-left: 10px;
            border-bottom: 1px solid #3d3d3d;
        }

        .excel-tab {
            padding: 10px 18px;
            color: #dcdcdc;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: color 0.1s;
        }

        .excel-tab:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.05);
            /* Hover effect */
        }

        .excel-tab.active-tab {
            color: #107c41;
            /* Excel Green */
            font-weight: 600;
            background-color: transparent;
        }

        .excel-tab.active-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 3px;
            background-color: #107c41;
            /* Green underline */
            border-radius: 3px 3px 0 0;
        }

        .excel-file-highlight {
            color: #ffffff !important;
            font-weight: 600;
            margin-right: 4px;
        }

        /* --- LUCKYSHEET DARK THEME OVERRIDES --- */

        /* --- LUCKYSHEET DARK THEME OVERRIDES --- */

        /* 1. TOP BAR & TOOLBAR STRIP - MANUAL DARK (No Invert) */
        /* We force these to be DARK so they look correct naturally */
        .luckysheet-grid-menu,
        .luckysheet_info_detail,
        .luckysheet-stat-area,
        .luckysheet-sheet-area,
        .luckysheet-bottom-controll-row,
        .luckysheet_info_detail_save,
        .luckysheet_info_detail_user,
        div.luckysheet-grid-menu {
            background-color: #252423 !important;
            color: #e5e5e5 !important;
        }

        /* 2. Container (Frame) */
        .luckysheet-container {
            background-color: #252423 !important;
            border: 1px solid var(--border);
        }

        /* 3. Toolbar Icons & Text: Force White */
        .luckysheet-container i,
        .luckysheet-container .fa,
        .luckysheet-iconfont-bold,
        .luckysheet-iconfont-italic,
        .luckysheet-iconfont-underline,
        .luckysheet-toolbar-menu-button,
        .luckysheet-toolbar-combo-button,
        .luckysheet-grid-menu-button,
        .luckysheet-item-name {
            color: #ffffff !important;
        }

        /* Hover states for buttons */
        .luckysheet-toolbar-menu-button:hover,
        .luckysheet-toolbar-combo-button:hover,
        .luckysheet-grid-menu-button:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* 4. WORK AREA (The Grid) - INVERT to make it dark */
        /* CRITICAL: We set background to WHITE so that INVERT turns it DARK. */
        /* If we set it to Dark, Invert makes it Light (Messy). */
        .luckysheet-work-area {
            background-color: #ffffff !important;
            filter: invert(0.9) hue-rotate(180deg) !important;
        }

        /* 5. Formula Bar - Manual Dark */
        .luckysheet-wa-editor {
            background-color: #252423 !important;
            color: #ffffff !important;
            border-bottom: 1px solid var(--border) !important;
        }

        .luckysheet-wa-editor div {
            color: #ffffff !important;
            /* Input text */
        }

        /* 6. Context Menus & Dropdowns - Invert to match Grid OR keep Dark if they are independent */
        /* These usually spawn inside work-area or body. If in body, they need their own invert. */
        .luckysheet-cols-menu-item,
        .luckysheet-filter-menu-box,
        .luckysheet-right-click-menu,
        .luckysheet-pk-menu,
        .luckysheet-mousedown-cancel {
            filter: invert(0.9) hue-rotate(180deg) !important;
        }

        /* 7. Sheet Tabs */
        .luckysheet-sheets-item {
            background-color: #3e3e3e !important;
            color: #aaa !important;
        }

        .luckysheet-sheets-item-active {
            background-color: #252423 !important;
            color: var(--primary) !important;
        }

        .modal {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
        }

        .modal-lg {
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Collection Styles */
        .collection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .col-kien h3 {
            color: #2563eb;
        }

        .col-cuong h3 {
            color: #f97316;
        }

        /* File List Styles */
        .file-list-header {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 5px;
            display: grid;
            grid-template-columns: 1fr 100px 30px;
            padding: 0 10px;
        }

        .file-item {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 100px 30px;
            align-items: center;
            transition: 0.2s;
        }

        .file-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .file-name {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .file-name:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .file-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media print {

            .sidebar,
            header,
            .no-print {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN SREEN -->
    <div id="view-login">
        <div class="login-card">
            <div style="margin-bottom: 2rem;">
                <i data-lucide="shield" style="width: 48px; height: 48px; color: var(--primary);"></i>
                <h2 style="margin-top: 10px; color: white;">SteelPro Đăng Nhập</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Vui lòng đăng nhập để tiếp tục</p>
            </div>
            <form onsubmit="event.preventDefault(); app.login()">
                <input type="text" id="login-user" class="login-input" placeholder="Tên đăng nhập" required>
                <input type="password" id="login-pass" class="login-input" placeholder="Mật khẩu" required>
                <button type="submit" class="login-btn">Đăng Nhập</button>
            </form>
        </div>
    </div>

    <nav class="sidebar">
        <div class="logo"> <i data-lucide="shield"></i> Kiên Cường </div>
        <div>
            <div class="nav-item active" onclick="app.switchView('dashboard')" id="nav-dashboard">
                <i data-lucide="layout-grid"></i> Tổng quan
            </div>
            <div class="nav-item" onclick="app.switchView('orders')" id="nav-orders">
                <i data-lucide="shopping-bag"></i> Đơn hàng
            </div>
            <div class="nav-item" onclick="app.switchView('customers')" id="nav-customers">
                <i data-lucide="users"></i> Khách hàng
            </div>
            <div class="nav-item" onclick="app.switchView('collection')" id="nav-collection">
                <i data-lucide="folder"></i> Thu phiếu
            </div>
            <div class="nav-item" onclick="app.switchView('reports')" id="nav-reports">
                <i data-lucide="bar-chart-3"></i> Báo cáo
            </div>
            <div class="nav-item" onclick="app.toggleTheme()" id="nav-theme">
                <i data-lucide="moon"></i> <span id="text-theme">Chế độ tối</span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <header>
            <h1 id="page-title">Tổng quan hệ thống</h1>
            <div style="display: flex; gap: 12px;">
                <!-- Hidden inputs -->
                <input type="file" id="file-excel" class="hidden" accept=".xlsx, .xls"
                    onchange="app.handleFile(this, 'excel')">
                <input type="file" id="file-word" class="hidden" accept=".docx" onchange="app.handleFile(this, 'word')">

                <button class="btn btn-outline" onclick="app.triggerUpload('orders', 'excel')">
                    <i data-lucide="upload"></i> Nhập đơn hàng
                </button>
                <button class="btn btn-primary" onclick="app.openModal('modal-add')">
                    <i data-lucide="plus"></i> Thêm đơn hàng
                </button>

                <div style="width: 1px; background: #444; margin: 0 8px;"></div>
                <button id="btn-sync-up" class="btn btn-outline" onclick="window.cloudSync.upload()"
                    title="Lưu lên Cloud">
                    <i data-lucide="cloud-upload"></i>
                </button>
                <button id="btn-sync-down" class="btn btn-outline" onclick="window.cloudSync.download()"
                    title="Tải về từ Cloud">
                    <i data-lucide="cloud-download"></i>
                </button>
                <span id="cloud-status-indicator"
                    style="display: flex; align-items: center; justify-content: center; transition: color 0.3s;">
                    <i data-lucide="cloud" style="width: 16px; height: 16px;"></i>
                </span>
            </div>
        </header>

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view">
            <div class="stats-grid">
                <div class="stat-card"><span>Tổng đơn hàng</span><span class="stat-value" id="d-total">0</span></div>
                <div class="stat-card"><span>Khối lượng (kg)</span><span class="stat-value" id="d-weight">0</span></div>
                <div class="stat-card"><span>Doanh thu</span><span class="stat-value" id="d-revenue">0 ₫</span></div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h3>Đơn hàng mới nhất</h3>
                </div>
                <table class="app-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>Khách</th>
                            <th>Hàng hóa</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="tb-recent"></tbody>
                </table>
            </div>
        </div>

        <!-- ORDERS -->
        <div id="view-orders" class="view hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Quản lý đơn hàng</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-outline" onclick="app.exportExcel()"> <i data-lucide="download"></i> Xuất
                            Excel</button>
                        <input type="text" placeholder="Tìm kiếm..." class="form-control"
                            style="width: 200px; margin:0;" oninput="app.renderOrders(this.value)">
                    </div>
                </div>
                <table class="app-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>Khách</th>
                            <th>Hàng</th>
                            <th>Lượng (kg)</th>
                            <th>Tiền</th>
                            <th>TT</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="tb-orders"></tbody>
                </table>
            </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="view-customers" class="view hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Khách hàng</h3>
                </div>
                <table class="app-table">
                    <thead>
                        <tr>
                            <th>Tên</th>
                            <th>Số đơn</th>
                            <th>Tổng Mua (kg)</th>
                            <th>Tổng Chi</th>
                        </tr>
                    </thead>
                    <tbody id="tb-customers"></tbody>
                </table>
            </div>
        </div>

        <!-- COLLECTION (THU PHIẾU) - REFACTORED TO FILES -->
        <div id="view-collection" class="view hidden">
            <div style="margin-bottom: 2rem;">
                <h2>Quản lý tệp thu phiếu</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Quản lý các file Excel/Word đã nhập. Bấm vào tên
                    file để mở và chỉnh sửa nội dung.</p>
            </div>

            <div class="collection-grid" style="grid-template-columns: 1fr;">
                <!-- KIEN -->
                <div class="col-kien" style="width: 100%;">
                    <div class="table-container">
                        <div class="table-header">
                            <div>
                                <h3>Kiên Cường</h3>
                                <span style="font-size:0.8rem; color:var(--text-muted);">Danh sách file</span>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-outline btn-sm"
                                    onclick="app.triggerUpload('col-kien', 'excel')"><i data-lucide="plus"></i>
                                    Excel</button>
                                <button class="btn btn-outline btn-sm" onclick="app.triggerUpload('raw-kien', 'excel')"
                                    title="Xem nguyên bản không qua xử lý"><i data-lucide="eye"></i> Raw</button>
                                <button class="btn btn-outline btn-sm"
                                    onclick="app.triggerUpload('col-kien', 'word')"><i data-lucide="plus"></i>
                                    Word</button>
                                <button class="btn btn-outline btn-sm" onclick="app.createEmptyFile('kien')"><i
                                        data-lucide="file-plus"></i> Mới</button>
                                <button class="btn btn-outline btn-sm" onclick="app.exportCollection('kien')"><i
                                        data-lucide="download"></i> Xuất</button>
                            </div>
                        </div>
                        <div style="padding:1rem;">
                            <div class="file-list-header">
                                <div>TÊN FILE</div>
                                <div>NGÀY TẠO</div>
                                <div></div>
                            </div>
                            <div id="list-kien"></div>
                        </div>
                    </div>
                </div>

                <!-- CUONG REMOVED -->
            </div>
        </div>

        <!-- REPORTS -->
        <div id="view-reports" class="view hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Doanh thu theo tháng</h3>
                    <div class="chart-container"><canvas id="chart-rev"></canvas></div>
                </div>
                <div class="stat-card">
                    <h3>Tỷ trọng sản phẩm</h3>
                    <div class="chart-container"><canvas id="chart-prod"></canvas></div>
                </div>
            </div>
        </div>

        <!-- EDITOR VIEW (Full Screen) -->
        <div id="view-editor" class="view hidden">
            <div class="table-container" style="height: calc(100vh - 100px); display:flex; flex-direction:column;">
                <div id="editor-default-header" class="table-header" style="background: var(--bg-body);">
                    <div style="display:flex; align-items:center; gap:15px; flex:1;">
                        <button class="btn btn-outline" onclick="app.switchView('collection')">
                            <i data-lucide="arrow-left"></i> Quay lại
                        </button>
                        <div style="border-left:1px solid var(--border); padding-left:15px;">
                            <input id="editor-filename" type="text"
                                style="font-weight:700; border:none; background:transparent; font-size:1.2rem; color:var(--primary); width:300px;"
                                placeholder="Tên file...">
                        </div>
                    </div>

                    <div style="display:flex; align-items:center; gap:20px;">
                        <div style="text-align:right;">
                            <div style="font-size:0.8rem; color:var(--text-muted);">TỔNG KẾT</div>
                            <div style="font-size:1.5rem; font-weight:700; color:var(--secondary);" id="editor-total">0
                                ₫</div>
                        </div>
                        <button id="editor-save-btn" onclick="app.saveLuckysheet()" class="btn btn-primary hidden"
                            style="background:var(--primary); color:white; border:none; padding: 8px 15px; font-weight:600; margin-right:10px;">
                            <i data-lucide="save"></i> Lưu Dữ Liệu
                        </button>
                        <button onclick="app.deleteFile(app.currentFileId, true)" class="btn btn-danger"
                            style="background:#fee2e2; color:#ef4444; border:1px solid #fecaca; padding: 8px 15px; font-weight:600;"><i
                                data-lucide="trash-2"></i> Xóa File</button>
                    </div>
                </div>

                <div style="flex-grow:1; overflow:hidden; padding:0; position:relative;">
                    <!-- Standard Table -->
                    <table id="editor-table-standard" style="width:100%; border-collapse:collapse; text-align: center;">
                        <thead
                            style="position:sticky; top:0; background:var(--bg-card); z-index:10; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th rowspan="2" style="width:50px; border-right:1px solid var(--border);">STT</th>
                                <th colspan="3" id="editor-header-owner"
                                    style="text-align:center; font-size:1rem; font-weight:700; color:var(--primary); padding:8px;">
                                    OWNER</th>
                                <th rowspan="2" style="width:50px;"></th>
                            </tr>
                            <tr>
                                <th style="font-weight:600; color:var(--text-muted);">PHIẾU</th>
                                <th style="font-weight:600; color:var(--text-muted);">LẺ</th>
                                <th style="font-weight:600; color:var(--text-muted);">LẺ</th>
                                <th style="font-weight:600; color:var(--text-muted);">TỔNG K</th>
                            </tr>
                        </thead>
                        <tbody id="editor-body"></tbody>
                    </table>

                    <!-- EXCEL UI WRAPPER -->
                    <div id="excel-ui-wrapper" class="hidden"
                        style="position:absolute; top:0; left:0; right:0; bottom:0; z-index:100; display:flex; flex-direction:column; background:#2b2b2b;">

                        <div id="excel-loading-screen" class="excel-loading-overlay hidden">
                            <div class="spinner"></div>
                            <div id="excel-loading-status" style="font-weight:600; font-size:14px; margin-bottom: 4px;">
                                Đang chuẩn bị Excel...</div>
                            <div style="font-size:11px; opacity:0.6;">Dữ liệu đang được giải nén và tải lên</div>
                        </div>

                        <!-- 1. Title Bar -->
                        <div id="excel-title-bar">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <i data-lucide="grid" style="color:#107c41; height:18px; width:18px;"></i>
                                <span style="font-size:12px; opacity:0.8;">AutoSave <span id="autosave-toggle"
                                        onclick="app.toggleAutoSave()"
                                        style="display:inline-block; width:24px; height:14px; background:#107c41; border-radius:10px; vertical-align:middle; margin-left:4px; position:relative; cursor:pointer; transition: background 0.3s;"><span
                                            id="autosave-dot"
                                            style="position:absolute; left:12px; top:2px; height:10px; width:10px; background:white; border-radius:50%; transition: left 0.3s;"></span></span></span>
                                <i data-lucide="save"
                                    style="height:16px; width:16px; margin-left:8px; opacity:0.7; cursor:pointer;"
                                    onclick="app.saveLuckysheet()"></i>
                                <i data-lucide="undo" style="height:16px; width:16px; opacity:0.7;"></i>
                                <i data-lucide="redo" style="height:16px; width:16px; opacity:0.7;"></i>
                            </div>

                            <div class="excel-title-center">
                                Book1 - Excel
                            </div>

                            <div style="display:flex; align-items:center; gap:16px;">
                                <div style="font-size:12px; opacity:0.7;">Admin</div>
                                <button id="excel-add-row-btn-top" class="hidden"
                                    style="background:#107c41; border:none; color:white; padding:4px 12px; border-radius:4px; font-size:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:4px;">
                                    <i data-lucide="plus" style="width:14px; height:14px;"></i> Thêm dòng ngang
                                </button>
                                <button id="excel-add-col-btn-top" class="hidden"
                                    style="background:#2563eb; border:none; color:white; padding:4px 12px; border-radius:4px; font-size:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:4px;">
                                    <i data-lucide="plus" style="width:14px; height:14px;"></i> Thêm cột dọc
                                </button>
                                <button id="btn-sync-down-excel" onclick="window.downloadFromCloud()"
                                    style="background:#0ea5e9; border:none; color:white; padding:4px 12px; border-radius:4px; font-size:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:4px;">
                                    <i data-lucide="cloud-download" style="width:14px; height:14px;"></i> Tải Cloud
                                </button>
                                <button onclick="app.switchView('collection')"
                                    style="background:transparent; border:1px solid #555; color:#ddd; padding:2px 8px; border-radius:4px; font-size:11px; cursor:pointer;">Thoát</button>


                                <div class="excel-window-controls">
                                    <div class="excel-control-btn red" onclick="app.switchView('collection')"></div>
                                    <div class="excel-control-btn yellow"></div>
                                    <div class="excel-control-btn green"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Ribbon Tabs -->
                        <div id="excel-ribbon-tabs">
                            <div class="excel-tab excel-file-highlight">Tệp</div>
                            <div class="excel-tab active-tab">Trang chủ</div>
                            <div class="excel-tab">Chèn</div>
                            <div class="excel-tab">Vẽ</div>
                            <div class="excel-tab">Bố cục</div>
                            <div class="excel-tab">Công thức</div>
                            <div class="excel-tab">Dữ liệu</div>
                            <div class="excel-tab">Xem lại</div>
                            <div class="excel-tab">Hiển thị</div>
                            <div class="excel-tab">Tự động</div>
                            <div class="excel-tab">Trợ giúp</div>
                        </div>

                        <!-- 3. RIBBON PANEL (HOME TAB) -->
                        <div id="excel-ribbon-panel">
                            <!-- Clipboard -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-btn large" id="ribbon-paste">
                                        <i data-lucide="clipboard-paste" style="width:24px; height:24px;"></i>
                                        <span>Dán</span>
                                    </div>
                                    <div class="ribbon-col">
                                        <div class="ribbon-btn small-row" id="ribbon-cut"><i data-lucide="scissors"
                                                style="width:14px;"></i> <span style="font-size:11px;">Cắt</span></div>
                                        <div class="ribbon-btn small-row" id="ribbon-copy"><i data-lucide="copy"
                                                style="width:14px;"></i> <span style="font-size:11px;">Sao chép</span>
                                        </div>
                                        <div class="ribbon-btn small-row" id="ribbon-fmt-painter"><i data-lucide="brush"
                                                style="width:14px;"></i> <span style="font-size:11px;">Định dạng</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-label">Bảng tạm</div>
                            </div>

                            <!-- Font -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-col" style="gap:4px;">
                                        <div class="ribbon-row">
                                            <div class="ribbon-select" id="ribbon-font-family"
                                                style="width:120px; height:22px;"><span>Calibri</span><i
                                                    data-lucide="chevron-down" style="width:12px;"></i></div>
                                            <div class="ribbon-select" id="ribbon-font-size"
                                                style="width:50px; height:22px;"><span>11</span><i
                                                    data-lucide="chevron-down" style="width:12px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-font-up"
                                                style="height:22px; width:22px;"><i data-lucide="a-large-small"
                                                    style="width:14px;"></i></div>
                                        </div>
                                        <div class="ribbon-row" style="gap:2px;">
                                            <div class="ribbon-btn" id="ribbon-bold" style="width:24px; height:24px;"><i
                                                    data-lucide="bold" style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-italic" style="width:24px; height:24px;">
                                                <i data-lucide="italic" style="width:14px;"></i>
                                            </div>
                                            <div class="ribbon-btn" id="ribbon-underline"
                                                style="width:24px; height:24px;"><i data-lucide="underline"
                                                    style="width:14px;"></i></div>
                                            <div style="width:1px; background:#555; margin:0 2px;"></div>
                                            <div class="ribbon-btn" id="ribbon-bg-color"
                                                style="width:24px; height:24px; border-bottom:3px solid yellow;"><i
                                                    data-lucide="paint-bucket" style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-text-color"
                                                style="width:24px; height:24px; border-bottom:3px solid red;"><i
                                                    data-lucide="type" style="width:14px;"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-label">Phông chữ</div>
                            </div>

                            <!-- Alignment -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-col">
                                        <div class="ribbon-row">
                                            <div class="ribbon-btn" id="ribbon-align-top"
                                                style="width:24px; height:22px;"><i data-lucide="align-start-vertical"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-align-middle"
                                                style="width:24px; height:22px;"><i data-lucide="align-center-vertical"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-align-bottom"
                                                style="width:24px; height:22px;"><i data-lucide="align-end-vertical"
                                                    style="width:14px;"></i></div>
                                            <div style="width:4px;"></div>
                                            <div class="ribbon-btn" id="ribbon-indent-dec"
                                                style="width:24px; height:22px;"><i data-lucide="indent-decrease"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-indent-inc"
                                                style="width:24px; height:22px;"><i data-lucide="indent-increase"
                                                    style="width:14px;"></i></div>
                                        </div>
                                        <div class="ribbon-row">
                                            <div class="ribbon-btn" id="ribbon-align-left"
                                                style="width:24px; height:22px;"><i data-lucide="align-left"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-align-center"
                                                style="width:24px; height:22px;"><i data-lucide="align-center"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-align-right"
                                                style="width:24px; height:22px;"><i data-lucide="align-right"
                                                    style="width:14px;"></i></div>
                                            <div style="width:4px;"></div>
                                            <div class="ribbon-btn small-row" id="ribbon-merge"
                                                style="width:auto; padding:0 4px; height:22px;"><i data-lucide="merge"
                                                    style="width:14px;"></i> <span style="font-size:11px;">Gộp ô</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-label">Căn chỉnh</div>
                            </div>

                            <!-- Number -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-col">
                                        <div class="ribbon-select" id="ribbon-fmt-general"
                                            style="width:110px; height:22px;"><span>General</span><i
                                                data-lucide="chevron-down" style="width:12px;"></i></div>
                                        <div class="ribbon-row" style="margin-top:2px;">
                                            <div class="ribbon-btn" id="ribbon-fmt-currency"
                                                style="width:24px; height:22px;"><span
                                                    style="font-size:11px; font-weight:bold;">$</span></div>
                                            <div class="ribbon-btn" id="ribbon-fmt-percent"
                                                style="width:24px; height:22px;"><span
                                                    style="font-size:11px; font-weight:bold;">%</span></div>
                                            <div class="ribbon-btn" id="ribbon-fmt-comma"
                                                style="width:24px; height:22px;"><span
                                                    style="font-size:11px; font-weight:bold;">,</span></div>
                                            <div class="ribbon-btn" id="ribbon-dec-inc"
                                                style="width:24px; height:22px;"><i data-lucide="move-left"
                                                    style="width:10px;"></i><sup style="font-size:9px;">.00</sup></div>
                                            <div class="ribbon-btn" id="ribbon-dec-dec"
                                                style="width:24px; height:22px;"><i data-lucide="move-right"
                                                    style="width:10px;"></i><sup style="font-size:9px;">.00</sup></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-label">Số</div>
                            </div>

                            <!-- Styles -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-btn large" id="ribbon-style-cond">
                                        <i data-lucide="layout-template"
                                            style="width:24px; height:24px; color:#5da3f0;"></i>
                                        <span>Có đ.kiện</span>
                                    </div>
                                    <div class="ribbon-btn large" id="ribbon-style-table">
                                        <i data-lucide="table" style="width:24px; height:24px; color:#eab308;"></i>
                                        <span>Là bảng</span>
                                    </div>
                                    <div class="ribbon-btn large" id="ribbon-style-cell">
                                        <i data-lucide="grid-2x2" style="width:24px; height:24px; color:#f87171;"></i>
                                        <span>Kiểu ô</span>
                                    </div>
                                </div>
                                <div class="group-label">Kiểu</div>
                            </div>

                            <!-- Cells -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-col">
                                        <div class="ribbon-btn small-row" id="ribbon-cell-ins" style="height:14px;"><i
                                                data-lucide="plus-square" style="width:14px;"></i> <span
                                                style="font-size:11px;">Chèn</span></div>
                                        <div class="ribbon-btn small-row" id="ribbon-cell-del" style="height:14px;"><i
                                                data-lucide="x-square" style="width:14px;"></i> <span
                                                style="font-size:11px;">Xóa</span></div>
                                        <div class="ribbon-btn small-row" id="ribbon-cell-fmt" style="height:14px;"><i
                                                data-lucide="layout" style="width:14px;"></i> <span
                                                style="font-size:11px;">Định dạng</span></div>
                                    </div>
                                </div>
                                <div class="group-label">Ô</div>
                            </div>

                            <!-- Editing -->
                            <div class="ribbon-group">
                                <div class="group-content">
                                    <div class="ribbon-col">
                                        <div class="ribbon-row">
                                            <div class="ribbon-btn" id="ribbon-edit-sum"
                                                style="width:24px; height:22px;"><i data-lucide="sigma"
                                                    style="width:14px;"></i></div>
                                            <div class="ribbon-btn" id="ribbon-edit-sort"
                                                style="width:24px; height:22px;">
                                                <i data-lucide="list-filter" style="width:14px;"></i>
                                            </div>
                                        </div>
                                        <div class="ribbon-row">
                                            <div class="ribbon-btn" id="ribbon-edit-find"
                                                style="width:24px; height:22px;">
                                                <i data-lucide="search" style="width:14px;"></i>
                                            </div>
                                            <div class="ribbon-btn" id="ribbon-edit-clear"
                                                style="width:24px; height:22px;">
                                                <i data-lucide="eraser" style="width:14px;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-label">Chỉnh sửa</div>
                            </div>

                        </div>

                        <!-- 3. ACTUAL LUCKYSHEET GRID -->
                        <div id="luckysheet"
                            style="flex-grow:1; position:relative; width:100%; height: calc(100vh - 180px); min-height: 500px; border-top:1px solid #444;">
                        </div>
                    </div>

                    <div id="editor-add-row-btn" style="padding:1rem;">
                        <button class="btn btn-outline" style="width:100%; border-style:dashed;"
                            onclick="app.editorAddRow()">+ Thêm dòng mới</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ADD MODAL -->
    <div id="modal-add" class="modal-overlay">
        <div class="modal">
            <h2>Thêm đơn hàng</h2>
            <form onsubmit="app.addOrder(event)">
                <label>Khách hàng</label><input id="in-name" class="form-control" required list="ls-cust"><datalist
                    id="ls-cust"></datalist>
                <label>Sản phẩm</label><input id="in-prod" class="form-control" required>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>Khối lượng (kg)</label><input type="number" id="in-qty" class="form-control" required>
                    </div>
                    <div><label>Đơn giá</label><input type="number" id="in-price" class="form-control" required></div>
                </div>
                <label>Ngày</label><input type="date" id="in-date" class="form-control" required>
                <div style="text-align:right; margin-top:1rem;">
                    <button type="button" class="btn btn-outline" onclick="app.closeModal('modal-add')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MAPPING MODAL -->
    <div id="modal-map" class="modal-overlay">
        <div class="modal">
            <h2>Khớp dữ liệu Excel</h2>
            <div id="map-area"></div>
            <div style="text-align:right; margin-top:1rem;">
                <button type="button" class="btn btn-outline" onclick="app.closeModal('modal-map')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="app.confirmImport()">Nhập</button>
            </div>
        </div>
    </div>

    <!-- MAPPING COLLECTION MODAL -->
    <div id="modal-map-col" class="modal-overlay">
        <div class="modal">
            <h2>Khớp dữ liệu Thu Phiếu</h2>
            <p id="map-col-title" style="margin-bottom:10px; font-weight:600;"></p>
            <div id="map-col-area"></div>
            <div style="text-align:right; margin-top:1rem;">
                <button type="button" class="btn btn-outline" onclick="app.closeModal('modal-map-col')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="app.confirmImportCollection()">Tạo File
                    Mới</button>
            </div>
        </div>
    </div>



    <script>
        const app = {
            data: JSON.parse(localStorage.getItem('steel_db')) || [],
            // NEW DATA STRUCTURE: Array of File Objects
            // { id, name, created, owner, items: [{day,month,year,content,amount}] }
            collectionFiles: JSON.parse(localStorage.getItem('steel_col_files')) || [],
            lastUpdated: localStorage.getItem('steel_last_updated') || "1970-01-01T00:00:00.000Z",

            autoSaveEnabled: localStorage.getItem('steel_autosave') !== 'false', // Persist state
            tempExcel: [],
            currentFileId: null, // For editor
            currentImportType: '',
            charts: {},

            init: function () {
                // AUTH CHECK
                if (!sessionStorage.getItem('isLoggedIn')) {
                    document.getElementById('view-login').style.display = 'flex';
                } else {
                    document.getElementById('view-login').style.display = 'none';
                }

                // Migration check (optional, dev use)
                const oldCol = localStorage.getItem('steel_col');
                if (oldCol && this.collectionFiles.length === 0) {
                    // Migrate old format to a "Legacy" file
                    const oldItems = JSON.parse(oldCol);
                    if (oldItems.length > 0) {
                        const kienItems = oldItems.filter(i => i.owner === 'kien');
                        if (kienItems.length) this.collectionFiles.push({ id: 'leg-k', name: 'Dữ liệu cũ (Kiên)', created: new Date().toISOString(), owner: 'kien', items: kienItems });
                        localStorage.setItem('steel_col_files', JSON.stringify(this.collectionFiles));
                        localStorage.removeItem('steel_col');
                    }
                }

                this.refreshIcons();
                this.switchView('dashboard');
                this.renderStats();

                // AUTO-RESUME SYNC: If previous session was interrupted while pushing
                if (localStorage.getItem('steel_pending_sync') === 'true') {
                    console.log("✅ Dữ liệu chưa đẩy lên xong lần trước. Đang thử lại...");
                    this.saveAndSync();
                }
            },

            login: function () {
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                if (u === 'kiencuong' && p === 'xuongtonkiencuong') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('current_user', u); // Set User ID
                    document.getElementById('view-login').style.display = 'none';
                    this.refreshIcons();
                    // Auto-Download from Cloud on Login - DISABLED to prevent overwriting local data
                    // if (window.cloudSync) window.cloudSync.download(true); 
                    console.log("✅ Logged in locally. Click Cloud Download button if you need to fetch old data.");
                } else {
                    alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                }
            },

            logout: function () {
                sessionStorage.removeItem('isLoggedIn');
                location.reload();
            },

            refreshIcons: function () { if (window.lucide) lucide.createIcons(); },

            switchView: function (viewId) {
                // CRITICAL: Force save Excel data before leaving editor
                const editorView = document.getElementById('view-editor');
                if (editorView && !editorView.classList.contains('hidden') && viewId !== 'editor') {
                    // We're leaving the editor, force immediate save
                    if (typeof luckysheet !== 'undefined' && window.app.currentFileId) {
                        try {
                            const sheets = luckysheet.getAllSheets();
                            const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                            if (file) {
                                file.luckysheetData = sheets;
                                // Immediate sync, no debounce
                                localStorage.setItem('steel_col_files', JSON.stringify(window.app.collectionFiles));
                                window.app.syncToCloud();
                                console.log('🔒 Forced Excel save on view switch');
                            }
                        } catch (e) {
                            console.error('Error forcing Excel save:', e);
                        }
                    }
                }

                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                if (document.getElementById('view-' + viewId)) document.getElementById('view-' + viewId).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if (document.getElementById('nav-' + viewId)) document.getElementById('nav-' + viewId).classList.add('active');

                document.getElementById('page-title').innerText = viewId === 'collection' ? 'Quản lý thu phiếu' : 'Hệ thống';

                if (viewId === 'collection') this.renderFiles();
                else this.renderData();

                if (viewId === 'reports') setTimeout(() => this.renderCharts(), 100);
                this.refreshIcons();
            },

            // --- DATA RENDERING ---
            renderData: function () {
                this.renderStats();
                this.renderRecent();
                this.renderOrders();
                this.renderCustomers();
            },

            renderStats: function () {
                const totalW = this.data.reduce((a, b) => a + Number(b.qty), 0);
                const totalR = this.data.reduce((a, b) => a + (b.qty * b.price), 0);
                document.getElementById('d-total').innerText = this.data.length;
                document.getElementById('d-weight').innerText = totalW.toLocaleString();
                document.getElementById('d-revenue').innerText = totalR.toLocaleString() + ' ₫';
            },

            renderRecent: function () {
                const html = this.data.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5)
                    .map(o => `<tr><td>${o.date}</td><td>${o.name}</td><td>${o.prod}</td><td><span class="status-badge status-${o.status}">${o.status === 'pending' ? 'Chờ' : 'Xong'}</span></td></tr>`).join('');
                document.getElementById('tb-recent').innerHTML = html;
            },

            renderOrders: function (q = '') {
                const html = this.data.filter(o => o.name.toLowerCase().includes(q.toLowerCase()) || o.prod.toLowerCase().includes(q.toLowerCase()))
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(o => `<tr><td>${o.date}</td><td><b>${o.name}</b></td><td>${o.prod}</td><td>${Number(o.qty).toLocaleString()}</td><td>${(o.qty * o.price).toLocaleString()}</td><td><select onchange="app.setStatus('${o.id}', this.value)" style="padding:4px;"><option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Chờ</option><option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Xong</option></select></td><td style="display:flex; gap:8px;"><button onclick="app.printOrder('${o.id}')" style="color:#2563eb; border:none; background:none;"><i data-lucide="printer"></i></button><button onclick="app.delOrder('${o.id}')" style="color:#ef4444; border:none; background:none;"><i data-lucide="trash-2"></i></button></td></tr>`).join('');
                document.getElementById('tb-orders').innerHTML = html;
                this.refreshIcons();
            },

            renderCustomers: function () {
                const map = {};
                this.data.forEach(o => {
                    if (!map[o.name]) map[o.name] = { c: 0, w: 0, r: 0 };
                    map[o.name].c++; map[o.name].w += Number(o.qty); map[o.name].r += (o.qty * o.price);
                });
                document.getElementById('ls-cust').innerHTML = Object.keys(map).map(n => `<option value="${n}">`).join('');
                document.getElementById('tb-customers').innerHTML = Object.entries(map).map(([n, d]) => `<tr><td><b>${n}</b></td><td>${d.c}</td><td>${d.w.toLocaleString()}</td><td style="color:#2563eb;">${d.r.toLocaleString()}</td></tr>`).join('');
            },

            // --- FILE BASED COLLECTION LOGIC ---
            renderFiles: function () {
                const renderList = (owner) => {
                    const files = this.collectionFiles.filter(f => f.owner === owner).sort((a, b) => new Date(b.created) - new Date(a.created));
                    if (files.length === 0) return '<div style="padding:10px; color:var(--text-muted); font-size:0.9rem; font-style:italic;">Chưa có file nào</div>';
                    return files.map(f => `
                        <div class="file-item" style="grid-template-columns: 1fr 100px 40px 40px; cursor:pointer;" onclick="app.openEditor('${f.id}')">
                            <div class="file-name"><i data-lucide="file-text" style="width:16px; display:inline-block; vertical-align:middle; margin-right:5px;"></i> ${f.name}</div>
                            <div class="file-meta">${new Date(f.created).toLocaleDateString('vi-VN')}</div>
                            <button onclick="event.stopPropagation(); app.downloadFile('${f.id}')" title="Tải xuống" 
                                style="color:#2563eb; background:rgba(37,99,235,0.1); border:none; border-radius:4px; width:28px; height:28px; cursor:pointer; display:flex; justify-content:center; align-items:center; margin-right:5px;">
                                <i data-lucide="download" style="width:16px; height:16px;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); app.deleteFile('${f.id}')" title="Xóa file" 
                                style="color:#ef4444; background:rgba(239,68,68,0.1); border:none; border-radius:4px; width:28px; height:28px; cursor:pointer; display:flex; justify-content:center; align-items:center;">
                                <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                            </button>
                        </div>
                    `).join('');
                };

                document.getElementById('list-kien').innerHTML = renderList('kien');
                this.refreshIcons();
            },

            createEmptyFile: function (owner) {
                const name = prompt("Nhập tên file mới:", "File mới " + new Date().toLocaleDateString('vi-VN'));
                if (name) {
                    const newFile = {
                        id: 'file-' + Date.now(),
                        name: name,
                        created: new Date().toISOString(),
                        owner: owner,
                        items: []
                    };
                    this.collectionFiles.push(newFile);
                    this.saveFiles();
                    this.openEditor(newFile.id);
                }
            },

            deleteFile: function (id, fromEditor = false) {
                if (confirm("Bạn có chắc muốn xóa toàn bộ file này không? Hành động này không thể hoàn tác!")) {
                    this.collectionFiles = this.collectionFiles.filter(f => f.id !== id);
                    this.saveFiles();
                    if (fromEditor) {
                        if (this.switchView) this.switchView('collection');
                        else {
                            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                            document.getElementById('view-collection').classList.remove('hidden');
                        }
                        this.currentFileId = null;
                    }
                }
            },

            saveFiles: function () {
                // 1. Lưu LocalStorage (Ưu tiên tốc độ)
                localStorage.setItem('steel_col_files', JSON.stringify(this.collectionFiles));

                // 2. Render lại giao diện
                this.renderFiles();

                // 3. Đồng bộ lên Cloud (Chạy ngầm - Homework Manager Style)
                this.syncToCloud();
            },

            syncToCloud: function () {
                const userId = 'kiencuong';
                const now = new Date().toISOString();
                localStorage.setItem('steel_pending_sync', 'true');

                const statusEl = document.getElementById('sync-status-indicator');
                if (statusEl) {
                    statusEl.innerHTML = '<span style="color:#eab308;">●</span> Đang chuẩn bị...';
                    statusEl.classList.remove('hidden');
                }

                if (typeof db !== 'undefined' && typeof firebase !== 'undefined') {
                    // SO SÁNH DỮ LIỆU CŨ - Tránh upload trùng lặp khi mạng lag
                    const currentFilesStr = JSON.stringify(this.collectionFiles);
                    if (this.lastSyncedFiles === currentFilesStr) {
                        if (statusEl) setTimeout(() => statusEl.classList.add('hidden'), 1000);
                        return Promise.resolve();
                    }

                    const optimizedFiles = this.collectionFiles.map(f => {
                        const fileCopy = { ...f };

                        // Nếu là Excel và chưa được nén dưới dạng nhị phân (hoặc vừa được update raw)
                        if (fileCopy.luckysheetData && Array.isArray(fileCopy.luckysheetData)) {
                            try {
                                // 1. Cắt tỉa dữ liệu thừa
                                fileCopy.luckysheetData.forEach(sheet => {
                                    // Xóa các thuộc tính render cồng kềnh không cần lưu
                                    delete sheet.visibledatarow;
                                    delete sheet.visibledatacolumn;
                                    delete sheet.ch_width;
                                    delete sheet.rh_height;

                                    if (sheet.data && Array.isArray(sheet.data)) {
                                        let maxR = 0, maxC = 0;
                                        sheet.data.forEach((r, ri) => {
                                            if (r) {
                                                r.forEach((c, ci) => {
                                                    if (c && (c.v !== undefined || c.f !== undefined || c.m !== undefined)) {
                                                        maxR = Math.max(maxR, ri); maxC = Math.max(maxC, ci);
                                                    }
                                                });
                                            }
                                        });
                                        sheet.data = sheet.data.slice(0, maxR + 1).map(r => r ? r.slice(0, maxC + 1) : []);
                                    }
                                });

                                // 2. Nén bằng Pako (Level 6 là cân bằng tốt nhất)
                                const jsonStr = JSON.stringify(fileCopy.luckysheetData);
                                const compressed = pako.deflate(jsonStr);

                                // 3. CHUYỂN SANG BINARY BLOB (Firestore cực nhanh)
                                // Lưu ý: firebase.firestore.Blob.fromUint8Array chỉ có ở SDK Compat
                                fileCopy.luckysheetData = firebase.firestore.Blob.fromUint8Array(compressed);
                                fileCopy.isBinary = true;
                                fileCopy.isCompressed = true;

                            } catch (e) {
                                console.error("Lỗi tối ưu file:", e);
                            }
                        }
                        return fileCopy;
                    });

                    if (statusEl) statusEl.innerHTML = '<span style="color:#3b82f6;">●</span> Đang tải lên...';

                    return db.collection('app_data').doc(userId).set({
                        files: optimizedFiles,
                        orders: this.data,
                        last_updated: now
                    }, { merge: true })
                        .then(() => {
                            this.lastSyncedFiles = JSON.stringify(this.collectionFiles); // Lưu vết đã sync
                            localStorage.removeItem('steel_pending_sync');
                            localStorage.setItem('steel_last_updated', now);
                            if (statusEl) {
                                statusEl.innerHTML = '<span style="color:#22c55e;">●</span> Hệ thống ổn định';
                                setTimeout(() => statusEl.classList.add('hidden'), 3000);
                            }
                        })
                        .catch(error => {
                            console.warn("⚠️ Đang ở chế độ Offline/Mạng yếu - Dữ liệu sẽ được đẩy lên sau.");
                            if (statusEl) {
                                statusEl.innerHTML = '<span style="color:#94a3b8;">●</span> Chờ mạng khỏe...';
                                // Tự ẩn sau 10s để không làm phiền
                                setTimeout(() => statusEl.classList.add('hidden'), 10000);
                            }
                        });
                }
                return Promise.resolve();
            },

            saveAndSync: function () {
                localStorage.setItem('steel_db', JSON.stringify(this.data));
                localStorage.setItem('steel_col_files', JSON.stringify(this.collectionFiles));
                return this.syncToCloud();
            },


            downloadFile: async function (id) {
                const file = this.collectionFiles.find(f => f.id === id);
                if (!file) return;

                const workbook = new ExcelJS.Workbook();

                // 1. RAW MODE (Luckysheet)
                if (file.isRaw && file.luckysheetData) {
                    try {
                        let displayData = file.luckysheetData;
                        // Handle compressed data if needed
                        if (typeof displayData === 'string' && displayData.startsWith("PZ:")) {
                            const binary = atob(displayData.substring(3));
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                            displayData = JSON.parse(pako.inflate(bytes, { to: 'string' }));
                        }

                        displayData.forEach((sheetData, index) => {
                            const sheet = workbook.addWorksheet(sheetData.name || `Sheet${index + 1}`);
                            const celldata = sheetData.celldata || [];

                            // If celldata is missing but data is present (2D array), convert it
                            if ((!celldata || celldata.length === 0) && sheetData.data) {
                                sheetData.data.forEach((row, r) => {
                                    if (row) {
                                        row.forEach((cell, c) => {
                                            if (cell && (cell.v !== undefined || cell.m !== undefined)) {
                                                celldata.push({ r, c, v: cell });
                                            }
                                        });
                                    }
                                });
                            }

                            celldata.forEach(cell => {
                                const r = cell.r;
                                const c = cell.c;
                                const cellValue = cell.v || {};
                                const val = cellValue.v !== undefined ? cellValue.v : (cellValue.m !== undefined ? cellValue.m : "");

                                const excelCell = sheet.getCell(r + 1, c + 1);
                                excelCell.value = val;

                                // Styles
                                if (cellValue.bg) {
                                    let bg = cellValue.bg.replace('#', '');
                                    if (bg.length === 3) bg = bg[0] + bg[0] + bg[1] + bg[1] + bg[2] + bg[2];
                                    excelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + bg } };
                                }
                                if (cellValue.fc || cellValue.bl || cellValue.it) {
                                    const font = {};
                                    if (cellValue.fc) {
                                        let fc = cellValue.fc.replace('#', '');
                                        if (fc.length === 3) fc = fc[0] + fc[0] + fc[1] + fc[1] + fc[2] + fc[2];
                                        font.color = { argb: 'FF' + fc };
                                    }
                                    if (cellValue.bl) font.bold = true;
                                    if (cellValue.it) font.italic = true;
                                    excelCell.font = font;
                                }
                                if (cellValue.ht) { // Horizontal align: 0 center, 1 left, 2 right
                                    const aligns = { 0: 'center', 1: 'left', 2: 'right' };
                                    excelCell.alignment = { horizontal: aligns[cellValue.ht] || 'left' };
                                }
                            });
                            // Default width
                            sheet.columns.forEach(col => { col.width = 12; });
                        });

                        const buffer = await workbook.xlsx.writeBuffer();
                        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = (file.name || "Export") + ".xlsx";
                        link.click();
                    } catch (e) {
                        console.error("Export Error:", e);
                        alert("Lỗi xuất file: " + e.message);
                    }
                }
                // 2. STANDARD MODE
                else {
                    const sheet = workbook.addWorksheet('Orders');
                    const headerRow = sheet.addRow(["STT", "PHIẾU", "LẺ 1", "LẺ 2", "TỔNG K"]);
                    headerRow.font = { bold: true };

                    if (file.items) {
                        file.items.forEach((item, idx) => {
                            sheet.addRow([idx + 1, item.phieu, item.le1, item.le2, item.tong]);
                        });
                    }

                    const sum = (file.items || []).reduce((s, i) => s + Number(i.tong || 0), 0);
                    const footerRow = sheet.addRow(["", "", "", "TỔNG:", sum]);
                    footerRow.getCell(4).font = { bold: true };
                    footerRow.getCell(5).font = { bold: true, color: { argb: 'FF0000FF' } };

                    sheet.getColumn(1).width = 5;
                    sheet.getColumn(2).width = 20;
                    sheet.getColumn(3).width = 15;
                    sheet.getColumn(4).width = 15;
                    sheet.getColumn(5).width = 20;

                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = (file.name || "Export") + ".xlsx";
                    link.click();
                }
            },

            // --- EDITOR LOGIC ---
            openEditor: function (fileId) {
                console.log("🚀 Mở file:", fileId);
                this.currentFileId = fileId;
                const file = this.collectionFiles.find(f => f.id === fileId);
                if (!file) { console.error("Không tìm thấy file"); return; }

                try {
                    // 1. Chuyển sang View Editor & Cập nhật tiêu đề
                    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                    document.getElementById('view-editor').classList.remove('hidden');

                    const nameInput = document.getElementById('editor-filename');
                    nameInput.value = file.name;
                    nameInput.onchange = (e) => { file.name = e.target.value; this.saveFiles(); };

                    // 2. GIẢI NÉN DỮ LIỆU
                    let displayData = file.luckysheetData;

                    // Case A: Dữ liệu nhị phân từ Firestore (Mới - Cực nhanh)
                    if (displayData && typeof displayData === 'object' && displayData.toUint8Array) {
                        try {
                            const bytes = displayData.toUint8Array();
                            displayData = JSON.parse(pako.inflate(bytes, { to: 'string' }));
                        } catch (e) {
                            console.error("❌ Lỗi giải nén Binary:", e);
                        }
                    }
                    // Case B: Dữ liệu nén PZ: (Base64 cũ - Chậm hơn)
                    else if (typeof displayData === 'string' && displayData.startsWith("PZ:")) {
                        try {
                            const binary = atob(displayData.substring(3));
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                            const decompressed = pako.inflate(bytes, { to: 'string' });
                            displayData = JSON.parse(decompressed);
                        } catch (e) {
                            console.error("❌ Lỗi giải nén PZ:", e);
                            displayData = [{ "name": "Sheet 1", "data": [], "index": 0, "status": 1 }];
                        }
                    }


                    const stdTable = document.getElementById('editor-table-standard');
                    const luckysheetDiv = document.getElementById('excel-ui-wrapper');
                    const addRowBtn = document.getElementById('editor-add-row-btn');
                    const saveBtn = document.getElementById('editor-save-btn');

                    if (file.isRaw && displayData) {
                        // --- CHẾ ĐỘ EXCEL TOÀN DIỆN ---
                        stdTable.classList.add('hidden');
                        luckysheetDiv.classList.remove('hidden');
                        if (saveBtn) saveBtn.classList.remove('hidden');

                        // Refresh Icons
                        if (window.lucide) setTimeout(() => lucide.createIcons(), 0);

                        // HIỆN MÀN HÌNH CHỜ (Chỉ hiện nếu máy xử lý quá 200ms để tránh bị loé trên máy mạnh)
                        const loadingScreen = document.getElementById('excel-loading-screen');
                        let loadingTimeout = null;
                        let forceHideTimeout = null; // Timeout cứng để ẩn nếu Luckysheet bị treo

                        if (loadingScreen) {
                            loadingScreen.style.opacity = '1';
                            loadingTimeout = setTimeout(() => {
                                if (document.getElementById('excel-ui-wrapper').classList.contains('hidden') === false) {
                                    loadingScreen.classList.remove('hidden');
                                    document.getElementById('excel-loading-status').innerText = "Đang khởi tạo dữ liệu...";
                                }
                            }, 200);

                            // TIMEOUT CỨNG: Ẩn loading sau 5s bất kể có gì xảy ra
                            forceHideTimeout = setTimeout(() => {
                                console.warn("⚠️ Force hiding loading screen after timeout");
                                if (loadingScreen) {
                                    loadingScreen.style.opacity = '0';
                                    setTimeout(() => loadingScreen.classList.add('hidden'), 300);
                                }
                            }, 5000);
                        }

                        // KIỂM TRA THƯ VIỆN LUCKYSHEET
                        if (typeof luckysheet === 'undefined') {
                            if (loadingScreen) {
                                document.getElementById('excel-loading-status').innerText = "Đang tải bộ công cụ (Mạng yếu)...";
                            }
                            console.warn("⚠️ Luckysheet chưa tải xong, đang thử lại sau 1.5s...");
                            setTimeout(() => this.openEditor(fileId), 1500);
                            return;
                        }

                        // GÁN LỆNH CHO NÚT THÊM DÒNG (+) TRÊN ĐẦU
                        const addRowTop = document.getElementById('excel-add-row-btn-top');
                        if (addRowTop) {
                            addRowTop.classList.remove('hidden');
                            addRowTop.onclick = () => {
                                if (typeof luckysheet !== 'undefined') {
                                    luckysheet.insertRow();
                                    const t = document.createElement('div');
                                    t.innerText = "➕ Đã thêm dòng ngang";
                                    t.style.cssText = "position:fixed; top:60px; right:20px; background:#107c41; color:white; padding:5px 10px; border-radius:4px; z-index:10001; font-size:12px;";
                                    document.body.appendChild(t);
                                    setTimeout(() => t.remove(), 1000);
                                }
                            };
                        }

                        // GÁN LỆNH CHO NÚT THÊM CỘT TRÊN ĐẦU
                        const addColTop = document.getElementById('excel-add-col-btn-top');
                        if (addColTop) {
                            addColTop.classList.remove('hidden');
                            addColTop.onclick = () => {
                                if (typeof luckysheet !== 'undefined') {
                                    luckysheet.insertColumn();
                                    const t = document.createElement('div');
                                    t.innerText = "➕ Đã thêm cột dọc";
                                    t.style.cssText = "position:fixed; top:60px; right:160px; background:#2563eb; color:white; padding:5px 10px; border-radius:4px; z-index:10001; font-size:12px;";
                                    document.body.appendChild(t);
                                    setTimeout(() => t.remove(), 1000);
                                }
                            };
                        }

                        // Ẩn nút cũ ở dưới đáy để tránh rối
                        if (addRowBtn) addRowBtn.classList.add('hidden');

                        const defHeader = document.getElementById('editor-default-header');
                        if (defHeader) defHeader.classList.add('hidden');
                        const excelTitle = document.querySelector('.excel-title-center');
                        if (excelTitle) excelTitle.innerText = file.name + ' - Excel';

                        document.getElementById('editor-header-owner').innerText = "FULL EXCEL MODE";
                        document.getElementById('editor-total').parentElement.classList.add('hidden');

                        // --- QUY TRÌNH KHỞI TẠO EXCEL (Tối ưu cho mạng cực yếu/DDoS) ---
                        const container = document.getElementById('luckysheet');
                        if (container) container.innerHTML = '';

                        // 1. CHẾ ĐỘ "LOCAL-FIRST": Dùng dữ liệu hiện có, không chờ Cloud
                        if (!Array.isArray(displayData) || displayData.length === 0) {
                            displayData = [{ "name": "Bản nháp", "status": 1, "order": 0, "data": [], "index": 0, "celldata": [] }];
                        }

                        // 2. Đảm bảo container luôn có chiều cao
                        if (container) container.style.height = 'calc(100vh - 180px)';

                        // 3. Khởi tạo với độ trễ an toàn và cấu hình tối giản (để qua mặt DDoS)
                        setTimeout(() => {
                            try {
                                luckysheet.create({
                                    container: 'luckysheet',
                                    data: displayData,
                                    lang: 'en',
                                    allowEdit: true,
                                    forceRefresh: true,
                                    showinfobar: false,
                                    showtoolbar: true,
                                    showstatisticBar: false,
                                    showsheetbar: true,
                                    devicePixelRatio: window.devicePixelRatio,
                                    hook: {
                                        updated: function () { if (typeof autoSaveData === 'function') autoSaveData(); },
                                        workbookCreateAfter: function () {
                                            if (loadingTimeout) clearTimeout(loadingTimeout);
                                            if (forceHideTimeout) clearTimeout(forceHideTimeout);

                                            // ẨN MÀN HÌNH CHỜ
                                            if (loadingScreen) {
                                                loadingScreen.style.opacity = '0';
                                                setTimeout(() => loadingScreen.classList.add('hidden'), 300);
                                            }

                                            // QUAN TRỌNG: VẼ LẠI ĐỂ ĐẢM BẢO HIỂN THỊ
                                            setTimeout(() => {
                                                if (typeof luckysheet !== 'undefined') {
                                                    luckysheet.resize();
                                                    console.log("✅ Excel đã sẵn sàng");
                                                }
                                            }, 200);
                                        }
                                    }
                                });
                                if (app.initRibbonEvents) app.initRibbonEvents();
                            } catch (err) {
                                console.error("Excel Init Error:", err);
                                if (forceHideTimeout) clearTimeout(forceHideTimeout);
                                if (loadingScreen) loadingScreen.classList.add('hidden');
                                alert("Lỗi khởi tạo Excel: " + err.message + ". Vui lòng thử lại hoặc kiểm tra dữ liệu file.");
                            }
                        }, 800);


                    } else {
                        // --- CHẾ ĐỘ NHẬP LIỆU PHIẾU THÔNG THƯỜNG ---
                        stdTable.classList.remove('hidden');
                        if (addRowBtn) addRowBtn.classList.remove('hidden');
                        luckysheetDiv.classList.add('hidden');
                        if (saveBtn) saveBtn.classList.add('hidden');

                        const addRowTop = document.getElementById('excel-add-row-btn-top');
                        if (addRowTop) addRowTop.classList.add('hidden');

                        const addColTop = document.getElementById('excel-add-col-btn-top');
                        if (addColTop) addColTop.classList.add('hidden');


                        const defHeader = document.getElementById('editor-default-header');
                        if (defHeader) defHeader.classList.remove('hidden');

                        document.getElementById('editor-total').parentElement.classList.remove('hidden');
                        const ownerName = file.owner === 'kien' ? 'KIÊN' : 'CƯỜNG';
                        document.getElementById('editor-header-owner').innerText = ownerName;
                        this.renderEditorItems(file);
                    }
                } catch (err) {
                    console.error("❌ Lỗi mở Editor:", err);
                    alert("Lỗi: " + err.message);
                }
            },

            renderEditorItems: function (file) {
                const html = file.items.map((item, idx) => `
                    <tr>
                        <td style="text-align:center; color:var(--text-muted); padding:5px; border-right:1px solid var(--border);">${idx + 1}</td>
                        <td style="padding:0; border-right:1px solid var(--border);"><input class="editable-cell" type="text" value="${item.phieu || ''}" onchange="app.updateItem('${file.id}', ${idx}, 'phieu', this.value)" style="text-align:center;"></td>
                        <td style="padding:0; border-right:1px solid var(--border);"><input class="editable-cell" type="number" value="${item.le1 || ''}" onchange="app.updateItem('${file.id}', ${idx}, 'le1', this.value)" style="text-align:center;"></td>
                        <td style="padding:0; border-right:1px solid var(--border);"><input class="editable-cell" type="number" value="${item.le2 || ''}" onchange="app.updateItem('${file.id}', ${idx}, 'le2', this.value)" style="text-align:center;"></td>
                        <td style="padding:0;"><input class="editable-cell" type="number" value="${item.tong || ''}" onchange="app.updateItem('${file.id}', ${idx}, 'tong', this.value)" style="font-weight:600; text-align:center; color:var(--primary);"></td>
                        <td><button onclick="app.deleteItem('${file.id}', ${idx})" style="color:red; border:none; background:none; cursor:pointer;"><i data-lucide="x"></i></button></td>
                    </tr>
                `).join('');

                document.getElementById('editor-body').innerHTML = html;
                const total = file.items.reduce((sum, i) => sum + Number(i.tong || 0), 0);
                document.getElementById('editor-total').innerText = total.toLocaleString() + ' ₫';
                if (window.lucide) lucide.createIcons();
            },

            getExcelColumnName: function (colIndex) {
                let temp, letter = '';
                while (colIndex >= 0) {
                    temp = colIndex % 26;
                    letter = String.fromCharCode(temp + 65) + letter;
                    colIndex = (colIndex - temp) / 26 - 1;
                }
                return letter;
            },

            renderRawEditor: function (file) {
                // Render Header
                const cols = file.cols || Object.keys(file.items[0] || {});
                const headHtml = `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="width:50px; border-right:1px solid var(--border); padding:8px; background:var(--bg-muted);"></th>
                        ${cols.map((c, i) => `
                            <th style="padding:8px; font-weight:600; color:var(--text-muted); border-right:1px solid var(--border); min-width:100px; background:var(--bg-muted); text-align:center;">
                                <div style="font-size:0.8rem;">${this.getExcelColumnName(i)}</div>
                                <div style="font-size:0.7rem; font-weight:normal; color:#999;">${c}</div>
                            </th>
                        `).join('')}
                        <th style="width:50px; background:var(--bg-muted);"></th>
                    </tr>
                `;
                document.getElementById('editor-raw-head').innerHTML = headHtml;

                // Render Body
                const bodyHtml = file.items.map((item, idx) => `
                    <tr>
                        <td style="text-align:center; color:var(--text-muted); padding:5px; border-right:1px solid var(--border); background:var(--bg-muted); font-size:0.8rem;">${idx + 1}</td>
                        ${cols.map(key => `
                            <td style="padding:0; border-right:1px solid var(--border);">
                                <input class="editable-cell" type="text" value="${item[key] === undefined ? '' : item[key]}" 
                                    onchange="app.updateRawItem('${file.id}', ${idx}, '${key}', this.value)" 
                                    style="text-align:center;">
                            </td>
                        `).join('')}
                        <td><button onclick="app.deleteItem('${file.id}', ${idx})" style="color:red; border:none; background:none; cursor:pointer;"><i data-lucide="x"></i></button></td>
                    </tr>
                `).join('');
                document.getElementById('editor-raw-body').innerHTML = bodyHtml;

                // Recalculate Totals
                this.calculateRawTotals(file);

                if (window.lucide) lucide.createIcons();
            },

            initRibbonEvents: function () {
                console.log('=== Initializing Excel Ribbon Events ===');
                const btnMap = {
                    'ribbon-bold': 'bold',
                    'ribbon-italic': 'italic',
                    'ribbon-underline': 'underline',
                    'ribbon-merge': 'merge-all',
                    'ribbon-align-left': 'left',
                    'ribbon-align-center': 'center',
                    'ribbon-align-right': 'right',
                    'ribbon-cell-ins': 'insert-row',
                    'ribbon-cell-del': 'delete-row',
                };

                Object.entries(btnMap).forEach(([id, cmd]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.onclick = () => {
                            if (typeof luckysheet === 'undefined') return;

                            // Essential Commands
                            if (cmd === 'insert-row') {
                                luckysheet.insertRow();
                            } else if (cmd === 'delete-row') {
                                luckysheet.deleteRow();
                            } else if (cmd === 'bold') {
                                luckysheet.setFontBold();
                            } else if (cmd === 'italic') {
                                luckysheet.setFontItalic();
                            } else {
                                // Fallback for other context-menu items
                                const luckysheetBtn = document.querySelector(`.luckysheet-icon-${cmd}`);
                                if (luckysheetBtn) luckysheetBtn.click();
                            }
                        };
                    }
                });

                // Add special listeners for more granular control if needed
                const insBtn = document.getElementById('ribbon-cell-ins');
                if (insBtn) {
                    insBtn.onclick = () => {
                        const count = prompt("Số dòng muốn thêm:", "1");
                        if (count && !isNaN(count)) {
                            luckysheet.insertRow(luckysheet.getluckysheet_select_save()[0].r, { number: parseInt(count) });
                        }
                    };
                }

                const delBtn = document.getElementById('ribbon-cell-del');
                if (delBtn) {
                    delBtn.onclick = () => {
                        if (confirm("Xóa dòng đang chọn?")) {
                            luckysheet.deleteRow();
                        }
                    };
                }
            },

            calculateRawTotals: function (file) {
                const cols = file.cols || Object.keys(file.items[0] || {});
                // Add footer if missing
                let tfoot = document.getElementById('editor-raw-foot');
                if (!tfoot) {
                    tfoot = document.createElement('tfoot');
                    tfoot.id = 'editor-raw-foot';
                    tfoot.style.position = 'sticky';
                    tfoot.style.bottom = '0';
                    tfoot.style.background = 'var(--bg-card)';
                    tfoot.style.boxShadow = '0 -2px 4px rgba(0,0,0,0.05)';
                    tfoot.style.fontWeight = 'bold';
                    document.getElementById('editor-table-raw').appendChild(tfoot);
                }

                const totals = cols.map(key => {
                    // Check if column is numeric
                    let sum = 0;
                    let isNumeric = true;
                    for (let item of file.items) {
                        const val = item[key];
                        if (val === '' || val === undefined || val === null) continue;
                        const num = Number(val);
                        if (isNaN(num)) {
                            isNumeric = false;
                            break;
                        }
                        sum += num;
                    }
                    return isNumeric ? sum : '';
                });

                tfoot.innerHTML = `
                    <tr>
                        <td style="padding:8px; text-align:center; border-right:1px solid var(--border); background:var(--bg-muted);">∑</td>
                        ${totals.map(t => `
                            <td style="padding:8px; text-align:center; border-right:1px solid var(--border); color:var(--primary);">
                                ${t !== '' ? t.toLocaleString() : ''}
                            </td>
                        `).join('')}
                        <td></td>
                    </tr>
                 `;
            },

            updateRawItem: function (fileId, idx, key, val) {
                const file = this.collectionFiles.find(f => f.id === fileId);
                if (file && file.items[idx]) {
                    file.items[idx][key] = val;
                    this.saveAndSync();
                    this.calculateRawTotals(file);
                }
            },

            updateItem: function (fileId, idx, field, val) {
                const file = this.collectionFiles.find(f => f.id === fileId);
                if (file && file.items[idx]) {
                    file.items[idx][field] = val;
                    this.saveAndSync();
                    this.renderEditorItems(file); // Re-render to update sum
                }
            },

            deleteItem: function (fileId, idx) {
                const file = this.collectionFiles.find(f => f.id === fileId);
                if (file) {
                    file.items.splice(idx, 1);
                    this.saveAndSync();
                    if (file.isRaw) this.renderRawEditor(file);
                    else this.renderEditorItems(file);
                }
            },

            editorAddRow: function () {
                const file = this.collectionFiles.find(f => f.id === this.currentFileId);
                if (file) {
                    if (file.isRaw) {
                        const newItem = {};
                        if (file.cols) file.cols.forEach(c => newItem[c] = '');
                        file.items.push(newItem);
                        this.saveAndSync();
                        this.renderRawEditor(file);
                    } else {
                        file.items.push({ phieu: '', le1: 0, le2: 0, tong: 0 });
                        this.saveAndSync();
                        this.renderEditorItems(file);
                    }
                }
            },

            saveLuckysheet: function () {
                if (window.luckysheet) {
                    const data = luckysheet.getAllSheets();
                    const file = this.collectionFiles.find(f => f.id === this.currentFileId);
                    if (file) {
                        file.luckysheetData = data;
                        this.saveAndSync();
                        const t = document.createElement('div');
                        t.innerText = "✅ Đã lưu Excel!";
                        t.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#107c41; color:white; padding:10px 20px; border-radius:30px; z-index:100001; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.3);";
                        document.body.appendChild(t);
                        setTimeout(() => t.remove(), 2500);
                    }
                }
            },

            // --- IMPORT LOGIC ---
            triggerUpload: function (target, type) {
                this.currentImportType = target;
                if (type === 'excel') document.getElementById('file-excel').click();
                if (type === 'word') document.getElementById('file-word').click();
            },

            handleFile: function (input, type) {
                const file = input.files[0];
                if (!file) return;
                this.tempFileName = file.name;

                if (type === 'excel') {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary' });

                            // Handle Raw Viewer Mode (Luckysheet)
                            if (this.currentImportType.startsWith('raw-')) {
                                const owner = this.currentImportType.split('-')[1];

                                // Use LuckyExcel to transform
                                LuckyExcel.transformExcelToLucky(file, (exportJson, luckysheetfile) => {
                                    if (exportJson.sheets.length > 0) {
                                        const uniqueId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                                        const newFile = {
                                            id: uniqueId,
                                            name: this.tempFileName,
                                            created: new Date().toISOString(),
                                            owner: owner,
                                            isRaw: true,
                                            luckysheetData: exportJson.sheets,
                                            items: []
                                        };

                                        this.collectionFiles.push(newFile);
                                        this.saveFiles();

                                        alert("Đã mở file thành công (Excel Mode)!");

                                        if (this.switchView) this.switchView('collection');
                                        else {
                                            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                                            document.getElementById('view-collection').classList.remove('hidden');
                                            this.renderFiles();
                                        }
                                    } else {
                                        alert("Không đọc được dữ liệu file Excel!");
                                    }
                                });
                                return;
                            }

                            // If NOT collection import (i.e. Orders), keep simple logic
                            if (!this.currentImportType.startsWith('col-')) {
                                this.tempExcel = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                if (this.tempExcel.length) {
                                    let cols = Object.keys(this.tempExcel[0]);
                                    this.showOrderMap(cols);
                                }
                                return;
                            }

                            // Collection Import: Scan ALL Sheets
                            let importedCount = 0;
                            let firstValidSheetData = null; // fallback
                            let firstValidSheetCols = null;

                            wb.SheetNames.forEach(sheetName => {
                                const ws = wb.Sheets[sheetName];
                                const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
                                let foundHeader = false;

                                // Validation Helper
                                const validateMap = (d, m) => {
                                    if (!m.tong) return false;
                                    let sum = 0;
                                    for (let i = 0; i < Math.min(d.length, 10); i++) {
                                        let val = d[i][m.tong];
                                        if (val) {
                                            // Handle various number formats: 1.000,00 or 1,000.00
                                            let s = String(val);
                                            // Simple heuristic: just strip non-numeric except dot/minus?
                                            // But VN format uses dot for thousands.
                                            // Let's strip key chars.
                                            let n = parseFloat(s.replace(/,/g, '').replace(/\./g, '').replace(/[^0-9.-]/g, ''));
                                            if (!isNaN(n) && n > 0) return true;
                                        }
                                    }
                                    return false;
                                };

                                // Scan first 20 rows for meaningful headers
                                for (let R = range.s.r; R <= Math.min(range.e.r, 20); ++R) {
                                    // Optimization: Read just this row and a few validation rows using sheet_to_json
                                    // This ensures we get the EXACT keys (handling duplicates like 'Phiếu_1') that XLSX generates
                                    const detectRange = { s: { r: R, c: range.s.c }, e: { r: Math.min(range.e.r, R + 10), c: range.e.c } };
                                    const dataDetect = XLSX.utils.sheet_to_json(ws, { range: detectRange });

                                    if (dataDetect.length === 0) continue;

                                    const keys = Object.keys(dataDetect[0]);
                                    const map = this.tryAutoMap(keys, this.currentImportType);

                                    // A strong match needs phieu or tong
                                    if ((map.phieu || map.tong) && validateMap(dataDetect, map)) {
                                        // Found header at row R
                                        // Now read FULL data from this header row
                                        const data = XLSX.utils.sheet_to_json(ws, { range: R });
                                        if (data.length > 0) {
                                            this.tempExcel = data;
                                            const originalName = this.tempFileName;
                                            this.tempFileName = `${originalName} - ${sheetName}`;
                                            this.confirmImportCollection(map);
                                            this.tempFileName = originalName;
                                            importedCount++;
                                            foundHeader = true;
                                        }
                                        break;
                                    }
                                }

                                // If no complex header found, try default row 0
                                if (!foundHeader) {
                                    const data = XLSX.utils.sheet_to_json(ws);
                                    if (data.length > 0) {
                                        const cols = Object.keys(data[0]);
                                        const map = this.tryAutoMap(cols, this.currentImportType);
                                        // If row 0 looks like a header, import it
                                        if ((map.phieu || map.tong) && validateMap(data, map)) {
                                            this.tempExcel = data;
                                            const originalName = this.tempFileName;
                                            this.tempFileName = `${originalName} - ${sheetName}`;
                                            this.confirmImportCollection(map);
                                            this.tempFileName = originalName;
                                            importedCount++;
                                        } else {
                                            // Save as fallback if it's the first sheet with data
                                            if (!firstValidSheetData) {
                                                firstValidSheetData = data;
                                                firstValidSheetCols = cols;
                                            }
                                        }
                                    }
                                }
                            });

                            if (importedCount === 0) {
                                if (firstValidSheetData) {
                                    this.tempExcel = firstValidSheetData;
                                    this.showCollectionMap(firstValidSheetCols, this.currentImportType);
                                } else {
                                    alert("Không tìm thấy dữ liệu hợp lệ trong file Excel này. Vui lòng kiểm tra lại cột 'Tổng' và đảm bảo số liệu > 0.");
                                }
                            } else {
                                alert(`Đã nhập thành công ${importedCount} sheet từ file Excel!`);
                            }

                        } catch (err) {
                            console.error(err);
                            alert("Có lỗi khi đọc file Excel: " + err.message);
                        }
                    };
                    reader.readAsBinaryString(file);
                } else if (type === 'word') {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        mammoth.convertToHtml({ arrayBuffer: e.target.result })
                            .then(result => {
                                const html = result.value;
                                this.parseWordTable(html);
                            })
                            .catch(err => alert("Lỗi đọc Word: " + err));
                    };
                    reader.readAsArrayBuffer(file);
                }
                input.value = '';
            },

            parseWordTable: function (htmlString) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                const table = doc.querySelector('table');
                if (!table) { alert("Không tìm thấy bảng nào trong file Word này!"); return; }

                const rows = Array.from(table.rows);
                if (rows.length < 2) { alert("Bảng dữ liệu quá ít dòng!"); return; }

                this.tempExcel = rows.slice(1).map(tr => {
                    const cells = Array.from(tr.cells).map(td => td.innerText.trim());
                    const obj = {};
                    cells.forEach((val, idx) => { obj[`Column_${idx + 1}`] = val });
                    return obj;
                });

                if (this.tempExcel.length > 0) {
                    const cols = Object.keys(this.tempExcel[0]);
                    // APPLY SAME AUTO LOGIC FOR WORD
                    const autoMap = this.tryAutoMap(cols);
                    if (autoMap) this.confirmImportCollection(autoMap);
                    else this.showCollectionMap(cols, this.currentImportType);
                } else {
                    alert("Không đọc được dữ liệu nào từ bảng.");
                }
            },

            showOrderMap: function (cols) {
                const fields = [{ k: 'name', l: 'Tên' }, { k: 'prod', l: 'Sản phẩm' }, { k: 'qty', l: 'Lượng' }, { k: 'price', l: 'Giá' }, { k: 'date', l: 'Ngày' }];
                document.getElementById('map-area').innerHTML = fields.map(f => `<div><label>${f.l}</label><select id="map-${f.k}" class="form-control"><option value="">--Chọn--</option>${cols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>`).join('');
                this.openModal('modal-map');
            },

            showCollectionMap: function (cols, target) {
                const who = target.includes('kien') ? 'Kiên' : 'Cường';
                document.getElementById('map-col-title').innerText = `Nhập dữ liệu cho: ${who}`;
                const fields = [{ k: 'phieu', l: 'Cột Phiếu' }, { k: 'le1', l: 'Cột Lẻ (1)' }, { k: 'le2', l: 'Cột Lẻ (2)' }, { k: 'tong', l: 'Cột Tổng K' }];
                document.getElementById('map-col-area').innerHTML = fields.map(f => `<div><label>${f.l}</label><select id="map-col-${f.k}" class="form-control"><option value="">--Chọn Cột--</option>${cols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>`).join('');
                this.openModal('modal-map-col');
            },

            tryAutoMap: function (cols, target) {
                let m = { phieu: '', le1: '', le2: '', tong: '' };
                const lowerCols = cols.map(c => String(c).toLowerCase());
                const isKien = target && target.includes('kien');
                const isCuong = target && target.includes('cuong');

                // 1. Identify all potential Total columns
                const totalCandidates = lowerCols.map((c, i) => ({ c, i, val: cols[i] }))
                    .filter(x => x.c.includes('tổng') || x.c.includes('tong') || x.c.includes('thành tiền'));

                let selectedTotal = null;

                if (isCuong) {
                    // Priority 1: Explicit 'C' or 'Cường'
                    selectedTotal = totalCandidates.find(x => x.c.includes('cường') || x.c.includes(' c') || /\bc\b/.test(x.c));
                    // Priority 2: If no explicit, pick the LAST total (assuming C is on the right)
                    if (!selectedTotal && totalCandidates.length > 0) {
                        selectedTotal = totalCandidates[totalCandidates.length - 1];
                    }
                } else {
                    // Default / Kien
                    // Priority 1: Explicit 'K' or 'Kiên'
                    selectedTotal = totalCandidates.find(x => x.c.includes('kiên') || x.c.includes(' k') || /\bk\b/.test(x.c));
                    // Priority 2: First total
                    if (!selectedTotal && totalCandidates.length > 0) {
                        selectedTotal = totalCandidates[0];
                    }
                }

                if (selectedTotal) {
                    m.tong = selectedTotal.val;
                    const tongIdx = selectedTotal.i;
                    // Search for Phieu/Le to the LEFT of Tong (0 to tongIdx)
                    // We assume Phieu is reasonably close.

                    // Find Phieu
                    // Search backwards from tongIdx for Phieu/Le
                    // We look for the closest valid columns
                    for (let i = tongIdx - 1; i >= 0; i--) {
                        const c = lowerCols[i];

                        // Phieu heuristic: 'phiếu', 'stt', 'nội dung'
                        if (!m.phieu) {
                            if (c.includes('phiếu') || c.includes('phieu') || c.includes('stt') || c.includes('nội dung')) {
                                m.phieu = cols[i];
                            }
                        }

                        // Le heuristic: 'lẻ', 'le'
                        if (c.includes('lẻ') || c.includes('le')) {
                            // Closest to total is likely le2 (Rightmost Le)
                            // Logic: Fill le2 first, then le1
                            if (!m.le2) m.le2 = cols[i];
                            else if (!m.le1) m.le1 = cols[i];
                        }
                    }
                    // Fix Le order logic if needed? 
                    // The loop goes R -> L. 
                    // File: Phieu | Le1 | Le2 | Tong
                    // Loop: Sees Le2 first -> assigns to m.le2. Then Le1 -> assigns to m.le1. Correct.
                }

                // If Proximity failed or didn't find Tong, try global search with strict Target preference
                // Removed redundant logic that caused crash
                if (!m.tong) {
                    // Robust search above covers this.
                }

                // Final Fallback: Index based
                if (!m.phieu && !m.tong) {
                    if (cols.length >= 8 && isCuong) {
                        // Likely 2nd block? 
                        // Just a guess. User says "content ntn"
                    }

                    if (cols.length >= 4) {
                        return { phieu: cols[0], le1: cols[1], le2: cols[2], tong: cols[3] };
                    }
                }

                // Fallback for independent missing fields
                if (!m.tong && cols.length > 0) m.tong = cols[cols.length - 1];
                if (!m.phieu && cols.length > 0) m.phieu = cols[0];

                return m;
            },

            confirmImport: function () {
                const m = { name: document.getElementById('map-name').value, prod: document.getElementById('map-prod').value, qty: document.getElementById('map-qty').value, price: document.getElementById('map-price').value, date: document.getElementById('map-date').value };
                const news = this.tempExcel.map(r => ({
                    id: 'imp-' + Math.random(),
                    name: r[m.name] || 'Khách',
                    prod: r[m.prod] || 'Sp',
                    qty: this.parseNum(r[m.qty]),
                    price: this.parseNum(r[m.price]),
                    date: this.fmtDate(r[m.date]),
                    status: 'pending'
                }));
                this.data = [...this.data, ...news];
                this.saveAndSync();
                this.closeModal('modal-map'); this.switchView('orders');
            },

            confirmImportCollection: function (mappingData) {
                // mappingData is optional. If not provided, read from DOM
                let m = mappingData;
                if (!m) {
                    m = {
                        phieu: document.getElementById('map-col-phieu').value,
                        le1: document.getElementById('map-col-le1').value,
                        le2: document.getElementById('map-col-le2').value,
                        tong: document.getElementById('map-col-tong').value
                    };
                }

                const owner = this.currentImportType.includes('kien') ? 'kien' : 'cuong';
                const newItems = this.tempExcel.map(r => ({
                    phieu: r[m.phieu] || '',
                    le1: this.parseNum(r[m.le1]),
                    le2: this.parseNum(r[m.le2]),
                    tong: this.parseNum(r[m.tong])
                }));

                const newFile = {
                    id: 'file-' + Date.now(),
                    name: this.tempFileName || 'Import mới',
                    created: new Date().toISOString(),
                    owner: owner,
                    items: newItems
                };

                this.collectionFiles.push(newFile);
                this.saveFiles();

                this.closeModal('modal-map-col');
                this.openEditor(newFile.id);
            },

            parseNum: function (val) {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                return parseFloat(val.toString().replace(/[^0-9.-]+/g, "")) || 0;
            },

            fmtDate: function (d) {
                if (!d) return new Date().toISOString().split('T')[0];
                if (typeof d === 'number') return new Date((d - 25569) * 86400 * 1000).toISOString().split('T')[0];
                const dateParsed = new Date(d);
                if (!isNaN(dateParsed.getTime())) return dateParsed.toISOString().split('T')[0];
                return new Date().toISOString().split('T')[0];
            },

            // --- REST ---
            renderCharts: function () {
                if (!window.Chart) return;
                const revByMonth = {}; const prodDist = {};
                this.data.forEach(o => {
                    const m = o.date.substring(0, 7);
                    revByMonth[m] = (revByMonth[m] || 0) + (o.qty * o.price);
                    prodDist[o.prod] = (prodDist[o.prod] || 0) + Number(o.qty);
                });
                if (this.charts.rev) this.charts.rev.destroy();
                if (this.charts.prod) this.charts.prod.destroy();

                const ctxRev = document.getElementById('chart-rev');
                if (ctxRev) this.charts.rev = new Chart(ctxRev, { type: 'bar', data: { labels: Object.keys(revByMonth).sort(), datasets: [{ label: 'Doanh thu', data: Object.values(revByMonth), backgroundColor: '#2563eb' }] } });

                const ctxProd = document.getElementById('chart-prod');
                if (ctxProd) this.charts.prod = new Chart(ctxProd, { type: 'doughnut', data: { labels: Object.keys(prodDist), datasets: [{ data: Object.values(prodDist), backgroundColor: ['#f97316', '#3b82f6', '#10b981', '#facc15', '#ec4899'] }] } });
            },

            addOrder: function (e) {
                e.preventDefault();
                this.data.push({
                    id: Date.now().toString(),
                    name: document.getElementById('in-name').value, prod: document.getElementById('in-prod').value,
                    qty: Number(document.getElementById('in-qty').value), price: Number(document.getElementById('in-price').value),
                    date: document.getElementById('in-date').value, status: 'pending'
                });
                this.saveAndSync();
                this.closeModal('modal-add'); e.target.reset(); this.switchView('orders'); alert('Đã thêm!');
            },
            delOrder: function (id) { if (confirm('Xóa?')) { this.data = this.data.filter(x => x.id !== id); this.saveAndSync(); this.renderOrders(); } },
            setStatus: function (id, st) { const o = this.data.find(x => x.id === id); if (o) { o.status = st; this.saveAndSync(); } },
            printOrder: function (id) {
                const o = this.data.find(x => x.id === id); if (!o) return;
                window.open('', '', 'width=800,height=600').document.write(`<html><body style="font-family:sans-serif;padding:30px;"><h1>Phiếu Giao</h1><p>Khách: ${o.name}</p>Table content...</body></html>`);
            },
            exportExcel: function () {
                XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.json_to_sheet(this.data), "Sheet1"), "Export.xlsx");
            },

            toggleTheme: function () {
                const isD = document.body.getAttribute('data-theme') === 'dark';
                document.body.setAttribute('data-theme', isD ? 'light' : 'dark');
                document.getElementById('nav-theme').innerHTML = `<i data-lucide="${isD ? 'moon' : 'sun'}"></i> <span>${isD ? 'Chế độ tối' : 'Sáng'}</span>`;
                this.refreshIcons();
            },
            openModal: function (id) { document.getElementById(id).style.display = 'flex'; if (id === 'modal-add') document.getElementById('in-date').value = new Date().toISOString().split('T')[0]; },
            exportCollection: function (owner) {
                const files = this.collectionFiles.filter(f => f.owner === owner);
                if (files.length === 0) {
                    alert("Chưa có file nào để xuất!");
                    return;
                }
                const data = files.map(f => ({
                    'Tên File': f.name,
                    'Ngày Tạo': new Date(f.created).toLocaleDateString('vi-VN'),
                    'ID': f.id
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "DanhSachFile");
                XLSX.writeFile(wb, `Danh_Sach_Phieu_${owner === 'kien' ? 'Kien_Cuong' : owner}.xlsx`);
            },

            toggleAutoSave: function () {
                this.autoSaveEnabled = !this.autoSaveEnabled;
                localStorage.setItem('steel_autosave', this.autoSaveEnabled);
                const toggle = document.getElementById('autosave-toggle');
                const dot = document.getElementById('autosave-dot');
                if (toggle && dot) {
                    if (this.autoSaveEnabled) {
                        toggle.style.background = '#107c41';
                        dot.style.left = '12px';
                    } else {
                        toggle.style.background = '#444';
                        dot.style.left = '2px';
                    }
                }

                const toast = document.createElement('div');
                toast.innerHTML = (this.autoSaveEnabled ? "🟢 Đã bật tự động lưu" : "⚪ Đã tắt tự động lưu");
                toast.style.cssText = "position:fixed; bottom:70px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:8px 16px; border-radius:30px; z-index:10000; font-size:13px; box-shadow:0 10px 25px rgba(0,0,0,0.3);";
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                if (this.autoSaveEnabled && window.app.pendingData) {
                    this.manualRefresh();
                }
            },

            manualRefresh: function () {
                if (window.app.pendingData) {
                    const data = window.app.pendingData;
                    window.app.data = data.orders || [];
                    window.app.collectionFiles = data.files || [];
                    localStorage.setItem('steel_db', JSON.stringify(window.app.data));
                    localStorage.setItem('steel_col_files', JSON.stringify(window.app.collectionFiles));

                    const editor = document.getElementById('view-editor');
                    if (editor && !editor.classList.contains('hidden')) {
                        const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                        if (file && file.luckysheetData) {
                            luckysheet.create({
                                container: 'luckysheet',
                                data: file.luckysheetData,
                                showinfobar: false, showtoolbar: true, lang: 'en',
                                hook: { updated: function () { if (typeof autoSaveData === 'function') autoSaveData(); } }
                            });
                        }
                    }
                    if (window.app.renderData) window.app.renderData();
                    if (window.app.renderFiles) window.app.renderFiles();

                    const t = document.getElementById('sync-pending-toast');
                    if (t) t.remove();
                    window.app.pendingData = null;

                    const toast = document.createElement('div');
                    toast.innerHTML = '✅ Đã cập nhật bản mới nhất';
                    toast.style.cssText = "position:fixed; top:10px; right:130px; background:#107c41; color:white; padding:5px 10px; border-radius:4px; z-index:10000; font-size:12px;";
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                }
            },

            closeModal: function (id) { document.getElementById(id).style.display = 'none'; }
        };

        window.app = app;
        app.init();

        // Sync UI for AutoSave
        if (!app.autoSaveEnabled) {
            setTimeout(() => {
                const toggle = document.getElementById('autosave-toggle');
                const dot = document.getElementById('autosave-dot');
                if (toggle && dot) {
                    toggle.style.background = '#444';
                    dot.style.left = '2px';
                }
            }, 500);
        }

        // ===== AUTO-SAVE IMPLEMENTATION =====
        let saveTimeout;
        function autoSaveData() {
            if (saveTimeout) clearTimeout(saveTimeout);
            const statusEl = document.getElementById('sync-status');
            if (statusEl) statusEl.innerText = "✍️...";
            // Tăng thời gian chờ lên 3 giây để giảm tải cho mạng yếu
            saveTimeout = setTimeout(performAutoSave, 3000);
        }

        function performAutoSave() {
            if (!window.app.autoSaveEnabled || typeof luckysheet === 'undefined' || !window.app.currentFileId) return;
            try {
                const sheets = luckysheet.getAllSheets();
                const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                if (file) {
                    file.luckysheetData = sheets;
                    window.app.saveAndSync();
                }
            } catch (err) { console.error('AutoSync error:', err); }
        }

        setInterval(() => {
            if (window.app.autoSaveEnabled && document.getElementById('view-editor') && !document.getElementById('view-editor').classList.contains('hidden')) {
                autoSaveData();
            }
        }, 10000);

        window.addEventListener('beforeunload', (e) => {
            const editor = document.getElementById('view-editor');
            if (editor && !editor.classList.contains('hidden') && typeof luckysheet !== 'undefined' && window.app.currentFileId) {
                try {
                    const sheets = luckysheet.getAllSheets();
                    const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                    if (file) {
                        file.luckysheetData = sheets;
                        localStorage.setItem('steel_col_files', JSON.stringify(window.app.collectionFiles));
                    }
                } catch (err) { console.error('Error in beforeunload:', err); }
            }
        });

        function hideCuongFolder() {
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.textContent && el.textContent.includes('Cường') && !el.querySelector('*')) {
                    const parent = el.closest('.category-item, .folder-card, .card, [class*="category"]');
                    if (parent) { parent.style.display = 'none'; }
                }
            });
        }

        // REALTIME: SETUP LISTENER
        function setupRealtimeSync() {
            const userId = 'kiencuong';
            if (typeof db === 'undefined' || typeof firebase === 'undefined') {
                setTimeout(setupRealtimeSync, 1000);
                return;
            }
            console.log("🚀 Listening for Cloud changes...");

            db.collection('app_data').doc(userId).onSnapshot((doc) => {
                if (localStorage.getItem('steel_pending_sync') === 'true') return;
                if (doc.metadata.hasPendingWrites) return;
                if (!doc.exists) return;

                // Giải nén dữ liệu nhị phân ngay khi nhận được
                let data = doc.data();
                if (data.files) {
                    data.files = data.files.map(f => {
                        if (f.luckysheetData && typeof f.luckysheetData === 'object' && f.luckysheetData.toUint8Array) {
                            try {
                                const bytes = f.luckysheetData.toUint8Array();
                                f.luckysheetData = JSON.parse(pako.inflate(bytes, { to: 'string' }));
                            } catch (e) { console.error("Lỗi giải nén realtime:", e); }
                        }
                        return f;
                    });
                }

                const cloudFilesStr = JSON.stringify(data.files || []);
                const cloudOrdersStr = JSON.stringify(data.orders || []);
                const localFilesStr = localStorage.getItem('steel_col_files') || '[]';
                const localOrdersStr = localStorage.getItem('steel_db') || '[]';
                if (cloudFilesStr === localFilesStr && cloudOrdersStr === localOrdersStr) return;

                const editor = document.getElementById('view-editor');
                const isExcelOpen = editor && !editor.classList.contains('hidden');

                if (!window.app.autoSaveEnabled && isExcelOpen) {
                    window.app.pendingData = data;
                    const oldToast = document.getElementById('sync-pending-toast');
                    if (oldToast) oldToast.remove();
                    const toast = document.createElement('div');
                    toast.id = 'sync-pending-toast';
                    toast.innerHTML = '🔔 Có bản cập nhật mới. <button onclick="app.manualRefresh()" style="background:#fff; color:#d97706; border:none; padding:2px 8px; border-radius:4px; margin-left:8px; cursor:pointer; font-weight:bold;">Tải ngay</button>';
                    toast.style.cssText = "position:fixed; top:10px; right:130px; background:#d97706; color:white; padding:8px 12px; border-radius:4px; z-index:10000; font-size:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); display:flex; align-items:center;";
                    document.body.appendChild(toast);
                    return;
                }

                console.log("🔄 Updating local data from Cloud...");
                window.app.data = data.orders || [];
                window.app.collectionFiles = data.files || [];
                localStorage.setItem('steel_db', JSON.stringify(window.app.data));
                localStorage.setItem('steel_col_files', JSON.stringify(window.app.collectionFiles));
                if (data.last_updated) localStorage.setItem('steel_last_updated', data.last_updated);

                if (window.app.renderData) window.app.renderData();
                if (window.app.renderFiles) window.app.renderFiles();

                if (isExcelOpen) {
                    const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                    if (file && file.luckysheetData) {
                        luckysheet.create({
                            container: 'luckysheet',
                            data: file.luckysheetData,
                            showinfobar: false, showtoolbar: true, lang: 'en',
                            hook: { updated: function () { if (typeof autoSaveData === 'function') autoSaveData(); } }
                        });
                        const toast = document.createElement('div');
                        toast.innerHTML = '🔄 Sync OK';
                        toast.style.cssText = "position:fixed; top:10px; right:130px; background:#2563eb; color:white; padding:5px 10px; border-radius:4px; z-index:10000; font-size:12px;";
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2000);
                    }
                } else {
                    const toast = document.createElement('div');
                    toast.innerHTML = '⚡ Synced';
                    toast.style.cssText = "position:fixed; bottom:20px; left:20px; background:#059669; color:white; padding:5px 10px; border-radius:20px; z-index:10000; font-size:12px;";
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                }
            });
        }
    </script>

    <!-- FIREBASE CLOUD SYNC -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB1oagqDT6U59-m_dcJk7eV_XrquPI3nts",
            authDomain: "quanlidonhang-4cd28.firebaseapp.com",
            projectId: "quanlidonhang-4cd28",
            storageBucket: "quanlidonhang-4cd28.firebasestorage.app",
            messagingSenderId: "593606962068",
            appId: "1:593606962068:web:70539633492aae55453d81"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();

            // KÍCH HOẠT CHẾ ĐỘ NGOẠI TUYẾN (Offline Mode)
            // Giúp bỏ qua lỗi mạng khi đang làm việc, tự động đồng bộ khi có mạng lại
            window.db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                if (err.code === 'failed-precondition') console.warn("Persistence failed: Many tabs open");
                else if (err.code === 'unimplemented') console.warn("Persistence not supported by browser");
            });

            console.log("✅ Firebase initialized with Persistence");
            setupRealtimeSync();
        } catch (e) { console.error("❌ Firebase error:", e); }

        window.downloadFromCloud = async function () {
            if (!confirm("⚠️ Tải dữ liệu từ CLOUD về sẽ GHI ĐÈ dữ liệu hiện tại trên máy này. Bạn có chắc chắn không?")) return;
            const userId = 'kiencuong';
            const btn = document.getElementById('btn-sync-down');
            const originalIcon = btn ? btn.innerHTML : '';
            if (btn) btn.innerHTML = '<span style="font-size:10px;">⏳</span>';

            try {
                const docSnap = await db.collection('app_data').doc(userId).get();
                if (docSnap.exists) {
                    let data = docSnap.data();

                    // Giải nén nhị phân trước khi lưu local
                    if (data.files) {
                        data.files = data.files.map(f => {
                            if (f.luckysheetData && typeof f.luckysheetData === 'object' && f.luckysheetData.toUint8Array) {
                                try {
                                    const bytes = f.luckysheetData.toUint8Array();
                                    f.luckysheetData = JSON.parse(pako.inflate(bytes, { to: 'string' }));
                                } catch (e) { console.error("Lỗi giải nén manual:", e); }
                            }
                            return f;
                        });

                        window.app.collectionFiles = data.files;
                        localStorage.setItem('steel_col_files', JSON.stringify(data.files));
                    }
                    if (data.orders) {
                        window.app.data = data.orders;
                        localStorage.setItem('steel_db', JSON.stringify(data.orders));
                    }
                    alert("✅ Đã tải về thành công! Ứng dụng sẽ khởi động lại.");
                    location.reload();
                } else {
                    alert("⚠️ Không có dữ liệu trên Cloud.");
                    if (btn) btn.innerHTML = originalIcon;
                }
            } catch (e) {
                alert("❌ Lỗi tải về: " + e.message);
                if (btn) btn.innerHTML = originalIcon;
            }
        };

        window.cloudSync = {
            upload: function () {
                if (window.app && window.app.syncToCloud) {
                    // 1. Force save Excel first if editor is open
                    const editorView = document.getElementById('view-editor');
                    if (editorView && !editorView.classList.contains('hidden')) {
                        if (typeof luckysheet !== 'undefined' && window.app.currentFileId) {
                            const sheets = luckysheet.getAllSheets();
                            const file = window.app.collectionFiles.find(f => f.id === window.app.currentFileId);
                            if (file) {
                                file.luckysheetData = sheets;
                                localStorage.setItem('steel_col_files', JSON.stringify(window.app.collectionFiles));
                            }
                        }
                    }

                    const btn = document.getElementById('btn-sync-up');
                    const originalIcon = btn ? btn.innerHTML : '';
                    if (btn) btn.innerHTML = '<span style="font-size:10px;">⏳</span>';

                    window.app.syncToCloud().then(() => {
                        const toast = document.createElement('div');
                        toast.innerHTML = '✅ Đã sao lưu Cloud thành công!';
                        toast.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#107c41; color:white; padding:10px 20px; border-radius:30px; z-index:10000; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.3);";
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2500);

                        if (btn) {
                            btn.innerHTML = originalIcon;
                            if (window.lucide) lucide.createIcons();
                        }
                    }).catch(() => {
                        alert("❌ Lỗi khi tải lên.");
                        if (btn) {
                            btn.innerHTML = originalIcon;
                            if (window.lucide) lucide.createIcons();
                        }
                    });
                }
            },
            download: function () { window.downloadFromCloud(); }
        };
    </script>
    <div id="sync-status-indicator" class="hidden"
        style="position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.8); color:white; padding:6px 14px; border-radius:20px; font-size:11px; z-index:99999; display:flex; align-items:center; gap:8px; pointer-events:none; backdrop-filter:blur(4px); border:1px solid rgba(255,255,255,0.1);">
        <span style="color:#eab308;">●</span> Đang đồng bộ...
    </div>
</body>

</html>